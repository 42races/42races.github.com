<p>Capistrano is a remote server automation and deployment tool written in Ruby. It is one of the best deployemnt tool availabel today. Capistrano is generic it can be used to deploy any application remotely.</p>

<h3>Installation</h3>
<div class="highlight"><pre><span class="nv">$ </span>gem install capistrano
</pre></div>
<p>or you can specify the gem in a Gemfile as follows, in ruby based projects (Rails, Sinatra etc)</p>
<div class="highlight"><pre><span class="n">group</span> <span class="o">:</span><span class="n">developemnt</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capistrano&#39;</span>
<span class="n">end</span>
</pre></div>
<p>check the version of installed capistrano using <strong>cap</strong> command</p>
<div class="highlight"><pre><span class="nv">$ </span>cap -V                               <span class="c"># or cap --version</span>
Capistrano Version: 3.0.1 <span class="o">(</span>Rake Version: 10.1.0<span class="o">)</span> <span class="c">###</span>
</pre></div>
<p>Capistrano version 3 is <strong>multistaged</strong> by default means you can setup your application to deploy in differnt environments (production, staging etc) without installing additional plugins.</p>

<p>Capistrano comes with a bunch of default task which you can list using.</p>
<div class="highlight"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>cap -vT                  <span class="c"># or simply cap -vT</span>
</pre></div>
<p>Here I am going to describe deploying a sinatra application to my VPS using capistrano. So lets say I have a sinatra application named &#39;foobar&#39; which is production ready and needs to be deployed to a VPS. The very basic deployment can be summarised in four steps.</p>

<p><strong>step1 :</strong> Add capistrano gem to Gemfile and run bundle command to install it</p>
<div class="highlight"><pre><span class="n">group</span> <span class="o">:</span><span class="n">development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capistrano&#39;</span>
<span class="n">end</span>

<span class="n">$</span> <span class="n">bundle</span>
</pre></div>
<p><strong>step2 :</strong> Install capistrano in your application</p>
<div class="highlight"><pre><span class="nv">$ </span>bundle <span class="nb">exec </span>cap install
</pre></div>
<p>This will add the following files to your application</p>
<div class="highlight"><pre><span class="vg">Capfile</span>
<span class="vg">config</span><span class="o">/</span><span class="vg">deploy</span><span class="o">.</span><span class="vg">rb</span>
<span class="vg">config</span><span class="o">/</span><span class="vg">deploy</span><span class="o">/</span><span class="vg">production</span><span class="o">.</span><span class="vg">rb</span>
<span class="vg">config</span><span class="o">/</span><span class="vg">deploy</span><span class="o">/</span><span class="vg">staging</span><span class="o">.</span><span class="vg">rb</span>
<span class="vg">lib</span><span class="o">/</span><span class="vg">capistrano</span><span class="o">/</span><span class="vg">tasks</span><span class="w">          </span><span class="err">#</span><span class="w"> </span><span class="vg">directory</span>
</pre></div>
<p><strong>setp3 :</strong> Edit the deploy.rb file and put the global configuration here</p>

<p>The file deploy.rb is generic to all the environments so edit this file to put general configuration, You can override the configuraion in the corresponding environment files later.</p>

<p>The set command is used to set static configurations.</p>
<div class="highlight"><pre><span class="kd">set</span> <span class="o">:</span><span class="n">application</span><span class="o">,</span> <span class="s1">&#39;foobar&#39;</span>                       <span class="err">#</span> <span class="n">application</span> <span class="n">name</span>
<span class="kd">set</span> <span class="o">:</span><span class="n">repo_url</span><span class="o">,</span> <span class="s1">&#39;git@example.com:me/foobar.git&#39;</span>   <span class="err">#</span> <span class="n">your</span> <span class="n">repo</span> <span class="n">url</span>
<span class="kd">set</span> <span class="o">:</span><span class="n">branch</span><span class="o">,</span> <span class="s1">&#39;master&#39;</span>                            <span class="err">#</span> <span class="n">branch</span> <span class="n">to</span> <span class="n">be</span> <span class="n">deployed</span>
<span class="kd">set</span> <span class="o">:</span><span class="n">keep_releases</span><span class="o">,</span> <span class="mi">2</span>                            <span class="err">#</span> <span class="n">keeps</span> <span class="n">only</span> <span class="n">two</span> <span class="n">copies</span> <span class="n">of</span> <span class="n">deployments</span>
</pre></div>
<p>The <strong>keep_release</strong> option above will keep upto 2 versions and deletes the previous deployments
If you want to input something while deploying like specifying branch name during deployment you can use <strong>ask</strong> command.</p>
<div class="highlight"><pre><span class="n">ask</span> <span class="o">:</span><span class="n">branch</span><span class="o">,</span> <span class="n">proc</span> <span class="o">{</span> <span class="err">`</span><span class="n">git</span> <span class="n">rev</span><span class="o">-</span><span class="n">parse</span> <span class="o">--</span><span class="n">abbrev</span><span class="o">-</span><span class="n">ref</span> <span class="n">HEAD</span><span class="err">`</span><span class="o">.</span><span class="na">chomp</span> <span class="o">}</span>
</pre></div>
<p>If you don&#39;t input anything the proc will be evaluated and branch will get assigned to the result.
Set the directory to which you want to deploy your application, and specify the version control used.
Here I have a deploy user in my VPS.</p>
<div class="highlight"><pre><span class="kd">set</span> <span class="o">:</span><span class="n">deploy_to</span><span class="o">,</span> <span class="s1">&#39;/home/deploy/apps/foobar&#39;</span>
<span class="kd">set</span> <span class="o">:</span><span class="n">scm</span><span class="o">,</span> <span class="o">:</span><span class="n">git</span>
</pre></div>
<p>The following options are also available for configuring capistrano output</p>
<div class="highlight"><pre><span class="kd">set</span> <span class="o">:</span><span class="n">format</span><span class="o">,</span> <span class="o">:</span><span class="n">pretty</span>
<span class="kd">set</span> <span class="o">:</span><span class="n">log_level</span><span class="o">,</span> <span class="o">:</span><span class="n">debug</span>
<span class="kd">set</span> <span class="o">:</span><span class="n">pty</span><span class="o">,</span> <span class="kc">true</span>
</pre></div>
<p><strong>step4 :</strong> Configure the environment file</p>

<p>Now it is the time to modify the environment file just open your environemnt file say deploy/production.rb.
Set the stage variable</p>
<div class="highlight"><pre><span class="kd">set</span> <span class="o">:</span><span class="n">stage</span><span class="o">,</span> <span class="o">:</span><span class="n">production</span>
</pre></div>
<p>Now change the roles</p>
<div class="highlight"><pre><span class="n">role</span> <span class="o">:</span><span class="n">app</span><span class="o">,</span> <span class="o">%</span><span class="n">w</span><span class="o">{</span><span class="n">deploy</span><span class="err">@</span><span class="o">&lt;</span><span class="n">vps_ip_address</span><span class="o">&gt;}</span>
<span class="n">role</span> <span class="o">:</span><span class="n">web</span><span class="o">,</span> <span class="o">%</span><span class="n">w</span><span class="o">{</span><span class="n">deploy</span><span class="err">@</span><span class="o">&lt;</span><span class="n">vps_ip_address</span><span class="o">&gt;}</span>
<span class="n">role</span> <span class="o">:</span><span class="n">db</span><span class="o">,</span>  <span class="o">%</span><span class="n">w</span><span class="o">{</span><span class="n">deploy</span><span class="err">@</span><span class="o">&lt;</span><span class="n">vps_ip_address</span><span class="o">&gt;}</span>
</pre></div>
<p>You can define as many roles as you need, also each role can have an array of servers as the second argument</p>
<div class="highlight"><pre><span class="n">eg</span><span class="o">:</span> <span class="n">role</span> <span class="o">:</span><span class="n">queue</span><span class="o">,</span> <span class="o">%</span><span class="n">w</span><span class="o">{</span> <span class="n">queue</span><span class="err">@</span><span class="n">server1</span> <span class="n">queue</span><span class="err">@</span><span class="n">server2</span> <span class="o">...}</span>
</pre></div>
<p>When you execute a task on a particular role, the generated command runs in all these servers with that role.
Here deploy is my deployment user on VPS, Rememmber you need to sign in to VPS and add your ssh key in ~/.ssh/authorizeds_keys in order to deploy your application.
Done</p>

<p>You can make use of capistrano plugins to easily add tasks such as bundle, asset compilation etc</p>

<p>For using rvm you can use.</p>
<div class="highlight"><pre><span class="vg">require</span><span class="w"> </span><span class="c1">&#39;capistrano/rvm&#39;</span>
</pre></div>
<p>You can require the bundle plugin to run the bundle command</p>
<div class="highlight"><pre><span class="vg">require</span><span class="w"> </span><span class="c1">&#39;capistrano/bundler&#39;</span>
</pre></div>
<p>If you are using puma server then you can use the puma plugin to start, stop and restart the server.</p>
<div class="highlight"><pre><span class="vg">require</span><span class="w"> </span><span class="c1">&#39;capistrano/puma&#39;</span>
</pre></div>
<p>If you are using a rails applicaiton you can use the following tasks too.</p>
<div class="highlight"><pre><span class="vg">require</span><span class="w"> </span><span class="c1">&#39;capistrano/rails/assets&#39;</span>
<span class="vg">require</span><span class="w"> </span><span class="c1">&#39;capistrano/rails/migrations&#39;</span>
</pre></div>
<p>You can now deploy your application by running</p>
<div class="highlight"><pre><span class="vg">cap</span><span class="w"> </span><span class="vg">production</span><span class="w"> </span><span class="vg">deploy</span>
</pre></div>